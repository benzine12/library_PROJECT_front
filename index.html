<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Book CRM</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Bootstrap CSS and Font Awesome -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/axios@1.6.7/dist/axios.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- Link to External CSS File -->
  <link rel="stylesheet" href="css/styles.css">

</head>

<body>
<!-- sidebar -->
  <nav class="navbar sidebar  d-none d-md-flex bg-dark ">
    <a href="index.html" class="navbar-brand text-light mb-4 d-flex align-items-center">
      <i class="fas fa-book-open me-2"></i> Book CRM
    </a>
    <ul class="nav flex-column w-100">
      <li class="nav-item mb-2">
        <a href="index.html" class="nav-link rounded-3 text-light active">
          <i class="fas fa-home me-2"></i> Home
        </a>
      </li>
      <li class="nav-item mb-2">
        <a href="customers.html" class="nav-link rounded-3 text-light">
          <i class="fas fa-user me-2"></i> Customers
        </a>
      </li>
      <li class="nav-item mb-2">
        <a href="books.html" class="nav-link rounded-3 text-light">
          <i class="fas fa-book me-2"></i> Books
        </a>
      </li>
      <li class="nav-item mb-2">
        <a href="loans.html" class="nav-link rounded-3 text-light">
          <i class="fas fa-hand-holding me-2"></i> Loans
        </a>
      </li>
      <li class="nav-item mb-2">
        <a href="reports.html" class="nav-link rounded-3 text-light">
          <i class="fas fa-chart-line me-2"></i> Reports
        </a>
      </li>
    </ul>
  </nav>

  <!-- Offcanvas Sidebar for Mobile -->
  <nav class="navbar navbar-dark bg-dark d-md-none">
    <div class="container-fluid d-flex align-items-center justify-content-between">
      <!-- Sidebar Toggle Button -->
      <button class="navbar-toggler me-2" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasSidebar"
        aria-controls="offcanvasSidebar">
        <span class="navbar-toggler-icon"></span>
      </button>
      <!-- Navbar Brand -->
      <a class="navbar-brand mx-auto" href="index.html">
        <i class="fas fa-book-open"></i> Book CRM
      </a>
      <!-- Username and Photo -->
      <div class="d-flex align-items-center">
        <span>Hi, David</span>
        <img src="images/boy-2.png" class="rounded-circle ms-2" alt="User Image">
      </div>
    </div>
  </nav>

  <!-- Offcanvas Content -->
  <div class="offcanvas offcanvas-start bg-dark text-light" tabindex="-1" id="offcanvasSidebar"
    aria-labelledby="offcanvasSidebarLabel">
    <div class="offcanvas-header">
      <h5 class="offcanvas-title" id="offcanvasSidebarLabel">
        <i class="fas fa-book-open"></i> Book CRM
      </h5>
      <button type="button" class="btn-close text-reset btn-close-white" data-bs-dismiss="offcanvas"
        aria-label="Close"></button>
    </div>
    <div class="offcanvas-body">
      <a href="index.html" class="nav-link active">
        <i class="fas fa-home"></i> Home
      </a>
      <a href="customers.html" class="nav-link">
        <i class="fas fa-user"></i> Customers
      </a>
      <a href="books.html" class="nav-link">
        <i class="fas fa-book"></i> Books
      </a>
      <a href="loans.html" class="nav-link">
        <i class="fas fa-hand-holding"></i> Loans
      </a>
      <a href="reports.html" class="nav-link">
        <i class="fas fa-chart-line"></i> Reports
      </a>
    </div>
  </div>

  <!-- Main Content -->
  <div class="content">
    <div class="container-fluid">
      <div class="row align-items-center mb-4">
        <div class="col-md-8 search-container">
          <form class="d-flex position-relative">
            <input class="form-control me-2" id="search-input" type="search" placeholder="Search books, customers" aria-label="Search" autocomplete="off">
            <button class="btn btn-outline-light" type="submit">Search</button>
            <!-- Autocomplete Dropdown -->
            <div class="autocomplete-dropdown" id="autocomplete-dropdown"></div>
          </form>
        </div>
        <!-- Username and Photo for Desktop -->
        <div class="col-md-4 text-end d-none d-md-block">
          <span>Hi, David</span>
          <img src="images/boy-2.png" class="rounded-circle ms-2" alt="User Image">
        </div>
      </div>

      <!-- Search Results Section -->
      <div class="container mt-4" id="search-results" style="display: none;">
        <h3>Search Results</h3>

        <!-- Books Results -->
        <div id="books-results" class="mb-4">
          <h4>Books</h4>
          <div class="list-group" id="books-list">
            <!-- Books will be dynamically inserted here -->
          </div>
        </div>

        <!-- Customers Results -->
        <div id="customers-results">
          <h4>Customers</h4>
          <div class="list-group" id="customers-list">
            <!-- Customers will be dynamically inserted here -->
          </div>
        </div>
      </div>

      <!-- Carousel -->
      <div id="carouselExampleControls" class="carousel slide mb-4 " data-bs-ride="carousel">
        <div class="carousel-inner rounded-3">
          <!-- First Slide -->
          <div class="carousel-item active ">
            <img src="https://images.unsplash.com/photo-1521587760476-6c12a4b040da?q=80&w=2940&auto=format&fit=crop"
              class="d-block w-100" alt="Featured Book">
            <div class="carousel-caption d-none d-md-block custom-caption">
              <h5>Featured Book</h5>
              <p>Discover our latest collection.</p>
            </div>
          </div>

          <!-- Second Slide -->
          <div class="carousel-item">
            <img src="https://images.unsplash.com/photo-1532543307581-8b01a7ff954f?q=80&w=2370&auto=format&fit=crop"
              class="d-block w-100" alt="New Arrivals">
            <div class="carousel-caption d-none d-md-block custom-caption ">
              <h5>New Arrivals</h5>
              <p>Check out new books in stock.</p>
            </div>
          </div>

          <!-- Third Slide -->
          <div class="carousel-item">
            <img src="https://images.unsplash.com/photo-1519389950473-47ba0277781c?q=80&w=2940&auto=format&fit=crop"
              class="d-block w-100" alt="Meet Our Team">
            <div class="carousel-caption d-none d-md-block custom-caption ">
              <h5>Meet Our Team</h5>
              <p>Our dedicated employees are here to help you find the perfect book.</p>
            </div>
          </div>
        </div>

        <!-- Carousel Controls -->
        <button class="carousel-control-prev" type="button" data-bs-target="#carouselExampleControls"
          data-bs-slide="prev">
          <span class="carousel-control-prev-icon" aria-hidden="true"></span>
          <span class="visually-hidden">Previous</span>
        </button>

        <button class="carousel-control-next" type="button" data-bs-target="#carouselExampleControls"
          data-bs-slide="next">
          <span class="carousel-control-next-icon" aria-hidden="true"></span>
          <span class="visually-hidden">Next</span>
        </button>
      </div>

      <!-- Active Cards -->
      <div class="row">
        <div class="col-md-4">
          <div class="card text-center p-3 mb-4" id="customers_num">
            <!-- Active Customers Count -->
          </div>
        </div>
        <div class="col-md-4">
          <div class="card text-center p-3 mb-4" id="loans_num">
            <!-- Active Loans Count -->
          </div>
        </div>
        <div class="col-md-4">
          <div class="card text-center p-3 mb-4" id="books_num">
            <!-- Active Books Count -->
          </div>
        </div>
      </div>

    </div>
  </div>
  <!-- Footer -->
  <footer class="footer py-3 text-center">
    <div class="container">
      <span>&copy; 2024 Book CRM</span> |
      <a href="index.html" class="text-light">Home</a> |
      <a href="about.html" class="text-light">About</a> |
      <a href="faq.html" class="text-light">FAQ</a>
    </div>
  </footer>

  <!-- Bootstrap JS Bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"></script>
  <!-- Custom JS Script -->
  <script>
    const SERVER = 'https://library-project-flask-sqlalchemy.onrender.com';

    const get_customers = () => {
      axios(SERVER + "/customers")
        .then(res => {
          const activeCustomers = res.data.filter(customer => customer.is_active);
          customers_num.innerHTML = `<p class="mb-1">Active customers</p><h4>${activeCustomers.length}</h4>`;
        })
        .catch(error => console.error('Error fetching customers:', error));
    };

    const get_loans = () => {
      axios(SERVER + "/loans")
        .then(res => {
          const activeLoans = res.data.filter(loan => loan.is_active);
          loans_num.innerHTML = `<p class="mb-1">Active loans</p><h4>${activeLoans.length}</h4>`;
        })
        .catch(error => console.error('Error fetching loans:', error));
    };

    const get_books = () => {
      axios(SERVER + "/books")
        .then(res => {
          const activeBooks = res.data.filter(book => book.is_active);
          books_num.innerHTML = `<p class="mb-1">Active books</p><h4>${activeBooks.length}</h4>`;
        })
        .catch(error => console.error('Error fetching books:', error));
    };

    // Function to handle search
    const handleSearch = (event) => {
      event.preventDefault(); // Prevent the default form submission

      const searchInput = document.querySelector('#search-input').value.trim();

      if (!searchInput) {
        alert('Please enter a search term.');
        return;
      }

      axios.get(`${SERVER}/search`, { params: { q: searchInput } })
        .then(res => {
          const { books, customers } = res.data;

          // Get the search results container
          const searchResults = document.getElementById('search-results');
          const booksList = document.getElementById('books-list');
          const customersList = document.getElementById('customers-list');

          // Clear previous results
          booksList.innerHTML = '';
          customersList.innerHTML = '';

          // Populate books results
          if (books.length > 0) {
            books.forEach(book => {
              const bookItem = document.createElement('a');
              bookItem.href = `books.html#${book.id}`; // Link to book details page
              bookItem.className = 'list-group-item list-group-item-action';
              bookItem.innerHTML = `<strong>${book.name}</strong> by ${book.author} (${book.year_published})`;
              booksList.appendChild(bookItem);
            });
          } else {
            booksList.innerHTML = '<p class="text-muted">No books found.</p>';
          }

          // Populate customers results
          if (customers.length > 0) {
            customers.forEach(customer => {
              const customerItem = document.createElement('a');
              customerItem.href = `customers.html#${customer.id}`; // Link to customer details page
              customerItem.className = 'list-group-item list-group-item-action';
              customerItem.innerHTML = `<strong>${customer.name}</strong> (${customer.email})`;
              customerItem.style.cursor = 'pointer';
              customersList.appendChild(customerItem);
            });
          } else {
            customersList.innerHTML = '<p class="text-muted">No customers found.</p>';
          }

          // Show the search results container
          searchResults.style.display = 'block';
        })
        .catch(error => {
          console.error('Error performing search:', error);
          alert('An error occurred while searching. Please try again.');
        });
    };

    // Attach the search handler to the form
    document.querySelector('form.d-flex').addEventListener('submit', handleSearch);

    // Function to periodically refresh data
    const startAutoRefresh = () => {
      // Refresh every 5 seconds (5000 milliseconds)
      setInterval(() => {
        get_customers();
        get_loans();
        get_books();
      }, 5000);
    };

    // Initialize the dashboard and start auto-refresh
    get_customers();
    get_loans();
    get_books();
    startAutoRefresh();

    // **Autocomplete Functionality**

    const searchInputElem = document.getElementById('search-input');
    const autocompleteDropdown = document.getElementById('autocomplete-dropdown');
    let activeSuggestionIndex = -1; // To keep track of keyboard navigation

    // Debounce function to limit the rate of API calls
    const debounce = (func, delay) => {
      let timeout;
      return function (...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, args), delay);
      };
    };

    // Function to fetch and display autocomplete suggestions
    const fetchSuggestions = debounce(() => {
      const query = searchInputElem.value.trim();
      if (!query) {
        autocompleteDropdown.style.display = 'none';
        autocompleteDropdown.innerHTML = '';
        return;
      }

      axios.get(`${SERVER}/search`, { params: { q: query } })
        .then(res => {
          const { books, customers } = res.data;
          const suggestions = [];

          // Prepare book suggestions
          books.forEach(book => {
            suggestions.push({
              type: 'Book',
              id: book.id,
              name: book.name,
              author: book.author,
              display: `<strong>${book.name}</strong> by ${book.author} (${book.year_published})`
            });
          });

          // Prepare customer suggestions
          customers.forEach(customer => {
            suggestions.push({
              type: 'Customer',
              id: customer.id,
              name: customer.name,
              email: customer.email,
              display: `<strong>${customer.name}</strong> (${customer.email})`
            });
          });

          // If no suggestions, hide the dropdown
          if (suggestions.length === 0) {
            autocompleteDropdown.style.display = 'none';
            autocompleteDropdown.innerHTML = '';
            return;
          }

          // Build the dropdown items
          autocompleteDropdown.innerHTML = '';
          suggestions.forEach((item, index) => {
            const suggestionItem = document.createElement('div');
            suggestionItem.className = 'autocomplete-item';
            suggestionItem.innerHTML = item.display;
            suggestionItem.dataset.type = item.type;
            suggestionItem.dataset.id = item.id;
            suggestionItem.dataset.index = index;

            // Click event to navigate to the respective page
            suggestionItem.addEventListener('click', (e) => {
              e.stopPropagation(); // Prevent form submission
              if (item.type === 'Book') {
                window.location.href = `books.html#${item.id}`;
              } else if (item.type === 'Customer') {
                window.location.href = `customers.html#${item.id}`;
              }
            });

            autocompleteDropdown.appendChild(suggestionItem);
          });

          // Reset active suggestion index
          activeSuggestionIndex = -1;

          // Show the dropdown
          autocompleteDropdown.style.display = 'block';
        })
        .catch(error => {
          console.error('Error fetching suggestions:', error);
          autocompleteDropdown.style.display = 'none';
          autocompleteDropdown.innerHTML = '';
        });
    }, 300); // 300ms debounce delay

    // Event listener for input changes
    searchInputElem.addEventListener('input', fetchSuggestions);

    // Event listener for keyboard navigation
    searchInputElem.addEventListener('keydown', (e) => {
      const items = autocompleteDropdown.getElementsByClassName('autocomplete-item');
      if (autocompleteDropdown.style.display === 'none' || items.length === 0) return;

      if (e.key === 'ArrowDown') {
        // Move down the suggestion list
        activeSuggestionIndex++;
        if (activeSuggestionIndex >= items.length) activeSuggestionIndex = 0;
        setActiveSuggestion(items);
        e.preventDefault();
      } else if (e.key === 'ArrowUp') {
        // Move up the suggestion list
        activeSuggestionIndex--;
        if (activeSuggestionIndex < 0) activeSuggestionIndex = items.length - 1;
        setActiveSuggestion(items);
        e.preventDefault();
      } else if (e.key === 'Enter') {
        // Trigger click on the active suggestion
        if (activeSuggestionIndex > -1 && items[activeSuggestionIndex]) {
          items[activeSuggestionIndex].click();
          e.preventDefault();
        }
      } else if (e.key === 'Escape') {
        // Hide the dropdown
        autocompleteDropdown.style.display = 'none';
      }
    });

    // Helper function to highlight the active suggestion
    const setActiveSuggestion = (items) => {
      for (let i = 0; i < items.length; i++) {
        items[i].classList.remove('active');
      }
      if (activeSuggestionIndex >= 0 && activeSuggestionIndex < items.length) {
        items[activeSuggestionIndex].classList.add('active');
        // Ensure the active item is visible within the dropdown
        items[activeSuggestionIndex].scrollIntoView({
          behavior: 'smooth',
          block: 'nearest'
        });
      }
    };

    // Event listener to close the dropdown when clicking outside
    document.addEventListener('click', (e) => {
      if (!document.querySelector('.search-container').contains(e.target)) {
        autocompleteDropdown.style.display = 'none';
      }
    });
  </script>

</body>

</html>